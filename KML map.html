<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KML Filtering Map</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAN7pjPBTfc66katRPl4d3bPx3R1p_m8WU&callback=initMap" async defer></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { display: flex; height: 100vh; }
        
        #sidebar {
            width: 300px; 
            background: #ffffff;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        #map {
            flex-grow: 1;
            height: 100%;
        }

        h2 { font-size: 18px; margin-bottom: 10px; color: #333; }
        .filter-section { margin-bottom: 15px; }
        .filter-section h3 { font-size: 16px; margin-bottom: 5px; color: #007BFF; }
        .filter-section label { display: block; font-size: 14px; margin-bottom: 5px; cursor: pointer; }
        .filter-section input[type="checkbox"] { margin-right: 8px; }
        .select-all {
    display: inline-block;
    padding: 8px 15px;
    background-color: #007BFF;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    text-align: center;
    margin-bottom: 5px;
}

.select-all:hover {
    background-color: #0056b3;
}
        button { width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px; }
        button:hover { background: #45a049; }
    </style>
</head>
<body>

    <div id="sidebar">
        <img src="https://raw.githubusercontent.com/markjpp/KMLMapping/main/Master Logo.png" alt="Master Logo" id="logo">

        <h2>Quarry Inspection Mapping</h2>

        <div class="filter-section">
            <h3>Folder Filter</h3>
            <span class="select-all" onclick="toggleSelectAll('folderFilter')">Select/Deselect All</span>
            <div id="folderFilters"></div>
        </div>

        <div id="extendedDataFilters"></div>

        <button onclick="applyFilter()">Apply Filter</button>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let markers = [];
        let folderData = {};
        let extendedDataFields = {};

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 53.1521, lng: -3.184305 },
                zoom: 8
            });
            
            bounds = new google.maps.LatLngBounds(); // Initialize bounds to calculate map zoom later
            fetchKML('https://raw.githubusercontent.com/markjpp/KMLMapping/main/quarries.kml');
        }

        function fetchKML(url) {
            fetch(url)
                .then(response => response.text())
                .then(kmlData => parseKML(kmlData))
                .catch(error => console.error("Failed to load KML:", error));
        }

        function parseKML(kml) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(kml, "text/xml");

            const folders = xmlDoc.getElementsByTagName("Folder");
            for (let i = 0; i < folders.length; i++) {
                const folder = folders[i];
                const folderName = folder.getElementsByTagName("name")[0].textContent.trim();
                folderData[folderName] = [];

                const placemarks = folder.getElementsByTagName("Placemark");
                for (let j = 0; j < placemarks.length; j++) {
                    const placemark = placemarks[j];
                    const name = placemark.getElementsByTagName("name")[0].textContent;
                    const description = placemark.getElementsByTagName("description")[0].textContent;
                    const coordinates = placemark.getElementsByTagName("coordinates")[0].textContent.trim().split(',');
                    const lat = parseFloat(coordinates[1]);
                    const lng = parseFloat(coordinates[0]);

                    let extendedData = {};
                    const dataElements = placemark.getElementsByTagName("ExtendedData")[0]?.getElementsByTagName("Data") || [];
                    for (let k = 0; k < dataElements.length; k++) {
                        const key = dataElements[k].getAttribute("name");
                        const value = dataElements[k].getElementsByTagName("value")[0].textContent.trim();
                        extendedData[key] = value;

                        if (!extendedDataFields[key]) {
                            extendedDataFields[key] = new Set();
                        }
                        extendedDataFields[key].add(value);
                    }

                    folderData[folderName].push({ name, description, lat, lng, extendedData });

                    // Extend bounds to include the placemark
                    bounds.extend(new google.maps.LatLng(lat, lng));
                }
            }

            createFilters();
            displayAllMarkers();
            map.fitBounds(bounds); // Automatically adjust map zoom level to fit all placemarks

        }

        function createFilters() {
            const folderFilters = document.getElementById("folderFilters");
            for (const folder in folderData) {
                const checkbox = createCheckbox(folder, "folderFilter", true);
                folderFilters.appendChild(checkbox);
            }

            const extendedFiltersContainer = document.getElementById("extendedDataFilters");
            extendedFiltersContainer.innerHTML = "";

            for (const field in extendedDataFields) {
                const section = document.createElement("div");
                section.classList.add("filter-section");
                const title = document.createElement("h3");
                title.textContent = field;
                section.appendChild(title);

                const selectAllToggle = document.createElement("span");
                selectAllToggle.classList.add("select-all");
                selectAllToggle.textContent = "Select/Deselect All";
                selectAllToggle.onclick = () => toggleSelectAll(`extendedFilter-${field}`);
                section.appendChild(selectAllToggle);

                extendedDataFields[field].forEach(value => {
                    const checkbox = createCheckbox(value, `extendedFilter-${field}`, true);
                    section.appendChild(checkbox);
                });

                extendedFiltersContainer.appendChild(section);
            }
        }

        function createCheckbox(labelText, idPrefix, isChecked) {
            const label = document.createElement("label");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = idPrefix + "-" + labelText;
            checkbox.checked = isChecked;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(labelText));
            return label;
        }

        function toggleSelectAll(idPrefix) {
            const checkboxes = document.querySelectorAll(`input[id^='${idPrefix}-']`);
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        function displayAllMarkers() {
            clearMarkers();
            for (const folder in folderData) {
                folderData[folder].forEach(place => addMarker(place));
            }
        }

        function addMarker(place) {
            const marker = new google.maps.Marker({
                position: { lat: place.lat, lng: place.lng },
                map: map,
                title: place.name
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<h3>${place.name}</h3><p>${place.description}</p>`
            });

            marker.addListener("click", () => infoWindow.open(map, marker));
            markers.push(marker);
        }

        function applyFilter() {
            clearMarkers();

            const selectedFolders = Array.from(document.querySelectorAll("input[id^='folderFilter-']:checked"))
                                        .map(cb => cb.id.replace("folderFilter-", ""));
            const selectedExtendedData = {};

            for (const field in extendedDataFields) {
                selectedExtendedData[field] = Array.from(document.querySelectorAll(`input[id^='extendedFilter-${field}-']:checked`))
                                                   .map(cb => cb.id.replace(`extendedFilter-${field}-`, ""));
            }

            if (selectedFolders.length === 0) {
                return; // Don't show any placemarks if no folder is selected
            }

            for (const folder in folderData) {
                folderData[folder].forEach(place => {
                    const folderMatch = selectedFolders.length === 0 || selectedFolders.includes(folder);
                    const extendedDataMatch = Object.keys(selectedExtendedData).every(field => {
                        const selectedValues = selectedExtendedData[field];
                        const placeValues = place.extendedData[field] ? [place.extendedData[field]] : [];
                        return selectedValues.some(val => placeValues.includes(val));
                    });

                    if (folderMatch && extendedDataMatch) {
                        addMarker(place);
                    }
                });
            }
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }
    </script>

</body>
</html>
